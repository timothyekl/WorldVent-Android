/*
 * WorldVentAndroid
 * sync-assets.gradle
 * Created by Michal Bojanowicz on 2020/4/19
 * Copyright (c) 2020. Michal Bojanowicz. All rights reserved
 */

task syncAssets() {
    println("syncing assets from git@github.com:timothyekl/WorldVent-Documentation.git")
    
    def stdout = new ByteArrayOutputStream()
    def repoSrc = "git@github.com:timothyekl/WorldVent-Documentation.git"
    def repoDir = "$project.rootDir/Documentation/worldvent"
    def repoGit = new File("$repoDir/.git")

    if (!repoGit.exists()) {
        exec {
            commandLine 'git', 'clone', repoSrc, repoDir
            standardOutput = stdout
        }
    } else {
        exec {
            workingDir repoDir
            commandLine 'git', 'pull'
            errorOutput = stdout
        }
    }
    println(stdout.toString().trim())

    println('copying assets into app assets folder')
    def src = "$project.rootDir/Documentation/worldvent"
    def destination = "$project.rootDir/app/src/main/assets/www"
    def destinationFile = new File(destination)

    if (!destinationFile.exists()) {
        exec {
            commandLine 'mkdir', '-p', destination
        }
    }

    exec {
        commandLine 'rsync', '-rtv', '--exclude', '.*', src, destination
        errorOutput = stdout
    }

    println(stdout.toString().trim())

    println("assert assets are copied")

    def assetsDir = "$project.rootDir/app/src/main/assets/www/worldvent"
    def worldVentIndex = new File("$assetsDir/index.html")
    if (!worldVentIndex.exists()) {
        throw new GradleException('Refer to README.me, where to copy html assets')
    }
    println("Synchronized documentation")
}
